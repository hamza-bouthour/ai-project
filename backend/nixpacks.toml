[phases.setup]
nixPkgs = [
  "nodejs_20",
  "python311",
  "python311Packages.pip"
]

[phases.install]
cmds = [
  "npm install",

  # wipe any previous broken python deps
  "rm -rf pydeps",
  "mkdir -p pydeps",

  # force binary wheels only (prevents numpy source-tree install)
  "/root/.nix-profile/bin/pip install --only-binary=:all: --target=pydeps numpy pandas scikit-learn joblib"
]

[phases.build]
cmds = [
  "cd /app && PYTHONPATH=/app/pydeps /root/.nix-profile/bin/python3 ml/train.py"
]

[start]
cmd = "node server.js"
